---
description: Refine draft specifications into architecture documents and implementation plans
argument-hint: <draft-*.md file path> [issue-number]
allowed-tools: Bash(bash $CLAUDE_PLUGIN_ROOT/skills/init-validator/scripts/*:*), Bash(bash $CLAUDE_PLUGIN_ROOT/skills/github-manager/scripts/*:*), Bash(bash $CLAUDE_PLUGIN_ROOT/skills/third-party-call/scripts/*:*), Bash(bash $CLAUDE_PLUGIN_ROOT/skills/docs-refactor/scripts/*:*), Bash(gh issue view:*), Bash(gh issue comment:*), Bash(gh pr create:*), Bash(git add:*), Bash(git commit:*), Bash(git push:*), Bash(git branch:*), Bash(git checkout:*), Bash(mkdir -p:*), Read, Write, Edit, Glob, Grep, Task, AskUserQuestion, TodoWrite, EnterPlanMode
---

# /refine-spec-to-arch

Refine a draft specification into complete architecture documents and implementation plans through interactive discussion and third-party evaluation.

## Context

- Repository: !`gh repo view --json nameWithOwner -q '.nameWithOwner' 2>/dev/null || echo "unknown"`
- Current branch: !`git branch --show-current`
- Draft file: $1
- Issue number: $2

---

## Phase 0: Validation

Run prerequisite check:

```bash
bash "${CLAUDE_PLUGIN_ROOT}/skills/init-validator/scripts/check-prerequisites.sh"
```

Validate inputs:

```bash
bash "${CLAUDE_PLUGIN_ROOT}/skills/init-validator/scripts/validate-refine.sh" "$1" "$2"
```

**If validation fails**: Display error and stop.

---

## Phase 1: Draft Analysis

### 1.1 Read Draft Document

Read the draft document completely using Read tool.

### 1.2 Identify Uncertainties

Extract and list:
- Open questions mentioned in the draft
- Ambiguous design decisions
- Missing details
- Undefined scope boundaries
- Unclear interfaces

### 1.3 Check Related Context

If issue number provided, fetch issue details:
```bash
gh issue view $2 --json title,body,comments
```

Search for related documentation and code.

---

## Phase 2: Interactive Refinement

### 2.1 Iterative Clarification

For each uncertainty identified, use AskUserQuestion to clarify:

Present the uncertainty and ask for guidance. Options should include:
1. Specific choice (with description)
2. Alternative choice
3. "Let me think" - provide more context
4. "Not important" - skip this detail

### 2.2 Third-Party Evaluation

After initial clarification, run external evaluation:

```bash
bash "${CLAUDE_PLUGIN_ROOT}/skills/third-party-call/scripts/run-analysis.sh" \
    --prompt-file "<prompt with draft + clarifications>" \
    --context-files "docs/**/*.md" \
    --output-file "./docs/draft/evaluation_<topic>.md"
```

The evaluation should check:
- Consistency with existing architecture
- Technical feasibility
- Potential conflicts
- Missing considerations

### 2.3 Final User Approval

Present evaluation results and ask for final approval:

**Options**:
1. **Approve** - Proceed to document generation
2. **Revise** - Provide additional feedback
3. **Stop** - Pause for more research

---

## Phase 3: Architecture Document Generation

### 3.1 Create Architecture Document

Generate `arch-<topic>.md` with complete architectural specification:

```markdown
# <Feature> Architecture

## Overview
[Complete, unambiguous description]

## Design Goals
1. [Goal 1]
2. [Goal 2]

## Architecture

### Component Diagram
[Description of components and their relationships]

### Data Flow
[How data moves through the system]

### API/Interfaces
[Detailed interface specifications]

## Implementation Constraints
- [Constraint 1]
- [Constraint 2]

## Dependencies
- [Existing component X]
- [Library Y]

## Testing Strategy
- Unit tests: [scope]
- Integration tests: [scope]

## Migration/Rollout
[If applicable]

## References
- [Related architecture docs]
- [Issue #N]

---
*Architecture document for Issue #<N>*
*Generated by GAAC /refine-spec-to-arch on <date>*
```

### 3.2 Size Check

Check document size:

```bash
bash "${CLAUDE_PLUGIN_ROOT}/skills/docs-refactor/scripts/check-doc-sizes.sh"
```

If arch document exceeds 1500 lines, split it:

```bash
bash "${CLAUDE_PLUGIN_ROOT}/skills/docs-refactor/scripts/split-document.sh" \
    --input "./docs/architecture/arch-<topic>.md" \
    --max-lines 1000
```

---

## Phase 4: Implementation Plan Generation

### 4.1 Create Implementation Plan

Generate `impl-<topic>.md` with detailed implementation steps:

```markdown
# <Feature> Implementation Plan

## Overview
[Brief summary linking to architecture]

## Prerequisites
- [ ] Architecture document reviewed: [link]
- [ ] Dependencies available

## Implementation Phases

### Phase 1: Foundation
**Estimated scope**: ~X lines

#### Tasks
1. [Task 1]
   - Files: `path/to/file.ts`
   - Changes: [description]
2. [Task 2]

#### Tests
- [ ] [Test case 1]
- [ ] [Test case 2]

#### Acceptance Criteria
- [ ] [Criterion 1]
- [ ] [Criterion 2]

### Phase 2: Core Implementation
[Similar structure]

### Phase 3: Integration
[Similar structure]

## Test-Driven Approach

For each phase:
1. Write failing tests first
2. Implement to pass tests
3. Refactor if needed

### Test Outline

```
tests/
├── unit/
│   └── <feature>/
│       ├── test_component1.ts
│       └── test_component2.ts
└── integration/
    └── test_<feature>_integration.ts
```

## Rollback Plan
[If implementation fails]

## References
- Architecture: [link to arch doc]
- Issue: #N

---
*Implementation plan for Issue #<N>*
*Generated by GAAC /refine-spec-to-arch on <date>*
```

### 4.2 Size Check and Split

If impl document exceeds limits, split by phase or topic.

---

## Phase 5: Version Control Integration

### 5.1 Create Feature Branch (if not exists)

```bash
git checkout -b docs/arch-<topic>-<issue>
```

### 5.2 Commit Architecture Documents

Only commit arch-*.md files (impl-*.md stays unstaged):

```bash
git add docs/architecture/arch-*.md
```

Create commit using github-manager:

```bash
bash "${CLAUDE_PLUGIN_ROOT}/skills/github-manager/scripts/create-commit.sh" \
    --issue $2 \
    --message "Add architecture document for <feature>"
```

### 5.3 Push and Create PR

```bash
git push -u origin $(git branch --show-current)
```

Create PR for architecture review:

```bash
bash "${CLAUDE_PLUGIN_ROOT}/skills/github-manager/scripts/create-pr.sh" \
    --title "[Docs][Arch][#$2] <Feature> architecture" \
    --body-file "<pr body with summary>" \
    --resolves $2
```

---

## Phase 6: Summary

### Outputs Created:

1. **Architecture documents**: `docs/architecture/arch-<topic>*.md`
   - Committed and pushed
   - PR created: #<pr-number>

2. **Implementation plans**: `docs/draft/impl-<topic>*.md`
   - Remain **unstaged** locally
   - Ready for `/plan-arch-to-issues`

3. **Draft document**: `docs/draft/draft-<topic>.md`
   - Can be archived or deleted

### Next Steps:

1. Wait for architecture PR review and merge
2. Run `/plan-arch-to-issues ./docs/draft/impl-*.md` to create implementation issues

---

## Notes

- Architecture documents are committed because they become project documentation
- Implementation plans remain local until converted to issues
- The three-party evaluation ensures design quality
- All design decisions should be explicitly documented
- Use EnterPlanMode for complex architectural decisions
- Maintain links between arch and impl documents
